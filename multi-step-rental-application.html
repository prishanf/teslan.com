<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>Residential Rental Application - Multi-Step</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<!-- Signature Pad -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f5f5f5;
}

.container {
    max-width: 850px;
    margin: 0 auto;
    background: white;
    padding: 40px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 24px;
}

.subtitle {
    text-align: center;
    color: #7f8c8d;
    margin-bottom: 30px;
    font-size: 14px;
}

h2 {
    background: #DDD;
    color: #2c3e50;
    padding: 10px;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 16px;
}

h3 {
    color: #2c3e50;
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 14px;
    border-bottom: 2px solid #000;
    padding-bottom: 5px;
}

.form-group {
    margin-bottom: 15px;
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.form-row>div {
    flex: 1;
}

label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #2c3e50;
    font-size: 13px;
}

input[type="text"],
input[type="email"],
input[type="tel"],
input[type="date"],
input[type="month"],
input[type="number"],
select,
textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #bdc3c7;
    border-radius: 4px;
    font-size: 14px;
}

textarea {
    resize: vertical;
    min-height: 60px;
}

.checkbox-group {
    display: flex;
    gap: 20px;
    align-items: center;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    font-weight: normal;
    margin-bottom: 0;
}

.checkbox-group input[type="radio"],
.checkbox-group input[type="checkbox"] {
    width: auto;
    margin-right: 5px;
}

.info-box {
    background: #ecf0f1;
    padding: 15px;
    border-left: 4px solid #3498db;
    margin-bottom: 20px;
    font-size: 13px;
}

.signature-section {
    margin-top: 30px;
    border-top: 2px solid #34495e;
    padding-top: 20px;
}

.consent-text {
    font-size: 12px;
    line-height: 1.6;
    margin-bottom: 20px;
    text-align: justify;
}

.consent-text ul {
    margin-left: 20px;
    margin-top: 10px;
}

.consent-text li {
    margin-bottom: 8px;
}

.signature-row {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.signature-field {
    flex: 1;
    padding-bottom: 20px;
    border: none;
}

.button-container {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    justify-content: center;
    flex-wrap: wrap;
}

button {
    padding: 12px 30px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-download {
    background: #27ae60;
    color: white;
}

.btn-download:hover {
    background: #229954;
}

.btn-blank {
    background: #3498db;
    color: white;
}

.btn-blank:hover {
    background: #2980b9;
}

.btn-clear {
    background: #e74c3c;
    color: white;
}

.btn-clear:hover {
    background: #c0392b;
}

.small-text {
    font-size: 11px;
    color: #7f8c8d;
    font-style: italic;
}

.signature-box {
    padding: 0;
    margin: 0;
    font-size: 14px;
    border-bottom: 1px solid #000;
    padding-top: 40px;
}

.signature-pad-container {
    margin: 15px 0;
}

.signature-pad-container canvas {
    border: 1px solid #bdc3c7;
    border-radius: 4px;
    background: white;
    cursor: crosshair;
    width: 100%;
    max-width: 400px;
    height: 150px;
}

.signature-pad-container label {
    margin-bottom: 8px;
}

.signature-controls {
    margin-top: 10px;
}

.signature-controls button {
    padding: 8px 15px;
    font-size: 14px;
    margin-right: 10px;
}

.typed-signature {
    width: 100%;
    padding: 8px;
    border: 1px solid #bdc3c7;
    border-radius: 4px;
    font-size: 14px;
    margin-top: 10px;
}

/* Multi-Step Form Styles */
.progress-container {
    margin-bottom: 30px;
    padding: 20px 0;
}

.progress-bar-wrapper {
    background: #ecf0f1;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 15px;
}

.progress-bar {
    background: linear-gradient(90deg, #3498db, #2980b9);
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

.progress-text {
    text-align: center;
    font-size: 14px;
    color: #7f8c8d;
    margin-bottom: 20px;
}

.step-indicators {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.step-indicator {
    flex: 1;
    min-width: 80px;
    text-align: center;
    padding: 10px 5px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
    position: relative;
}

.step-indicator .step-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    line-height: 1;
    border-radius: 50%;
    background: #ecf0f1;
    color: #7f8c8d;
    font-weight: bold;
    margin-bottom: 5px;
    transition: all 0.3s;
    text-align: center;
}

.step-indicator .step-title {
    font-size: 11px;
    color: #7f8c8d;
    display: block;
}

.step-indicator.completed .step-number {
    background: #27ae60;
    color: white;
}

.step-indicator.active .step-number {
    background: #3498db;
    color: white;
    transform: scale(1.1);
}

.step-indicator.completed .step-title,
.step-indicator.active .step-title {
    color: #2c3e50;
    font-weight: bold;
}

.step-container {
    display: none;
    animation: fadeIn 0.3s ease-in;
}

.step-container.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.step-navigation {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #ecf0f1;
}

.step-navigation button {
    min-width: 120px;
}

.btn-next {
    background: #27ae60;
    color: white;
    margin-left: auto;
}

.btn-next:hover {
    background: #229954;
}

.btn-previous {
    background: #95a5a6;
    color: white;
}

.btn-previous:hover {
    background: #7f8c8d;
}

.btn-save {
    background: #9b59b6;
    color: white;
}

.btn-save:hover {
    background: #8e44ad;
}

.field-error {
    border-color: #e74c3c !important;
    background-color: #fee;
}

.error-message {
    color: #e74c3c;
    font-size: 12px;
    margin-top: 5px;
    display: none;
}

.error-message.show {
    display: block;
}

/* Mobile Responsive Styles */
@media screen and (max-width: 768px) {
    body {
        padding: 10px;
        background: #f5f5f5;
    }

    .container {
        padding: 20px 15px;
        max-width: 100%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    h1 {
        font-size: 20px;
        margin-bottom: 8px;
    }

    .subtitle {
        font-size: 13px;
        margin-bottom: 20px;
    }

    h2 {
        font-size: 15px;
        padding: 12px 10px;
        margin-top: 20px;
        margin-bottom: 12px;
    }

    h3 {
        font-size: 13px;
        margin-top: 18px;
        margin-bottom: 8px;
    }

    .form-row {
        flex-direction: column;
        gap: 0;
        margin-bottom: 15px;
    }

    .form-row > div {
        margin-bottom: 15px;
    }

    .form-row > div:last-child {
        margin-bottom: 0;
    }

    .form-group {
        margin-bottom: 18px;
    }

    label {
        font-size: 14px;
        margin-bottom: 6px;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="month"],
    input[type="number"],
    select,
    textarea {
        padding: 12px;
        font-size: 16px;
        border-radius: 6px;
        -webkit-appearance: none;
        appearance: none;
    }

    input[type="date"],
    input[type="month"] {
        min-height: 44px;
    }

    textarea {
        min-height: 80px;
        font-size: 16px;
    }

    .checkbox-group {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }

    .checkbox-group label {
        font-size: 15px;
        padding: 8px 0;
        min-height: 44px;
        display: flex;
        align-items: center;
    }

    .checkbox-group input[type="radio"],
    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        flex-shrink: 0;
    }

    .info-box {
        padding: 12px;
        font-size: 13px;
        margin-bottom: 18px;
    }

    .signature-row {
        flex-direction: column;
        gap: 15px;
    }

    .signature-pad-container {
        margin: 20px 0;
    }

    .signature-pad-container canvas {
        width: 100%;
        max-width: 100%;
        height: 120px;
        touch-action: none;
    }

    .signature-controls button {
        padding: 10px 20px;
        font-size: 15px;
        min-height: 44px;
        width: 100%;
        margin-bottom: 10px;
        margin-right: 0;
    }

    .signature-controls button:last-child {
        margin-bottom: 0;
    }

    .button-container {
        flex-direction: column;
        gap: 12px;
        margin-top: 25px;
    }

    button {
        width: 100%;
        padding: 14px 20px;
        font-size: 16px;
        min-height: 48px;
        border-radius: 6px;
    }

    .consent-text {
        font-size: 13px;
        line-height: 1.7;
    }

    .consent-text ul {
        margin-left: 15px;
    }

    .small-text {
        font-size: 12px;
    }

    .typed-signature {
        font-size: 16px;
        padding: 12px;
        min-height: 44px;
    }

    .progress-container {
        padding: 15px 0;
    }

    .step-indicators {
        flex-direction: column;
        gap: 8px;
    }

    .step-indicator {
        min-width: 100%;
        text-align: left;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
    }

    .step-indicator .step-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        vertical-align: middle;
        text-align: center;
        line-height: 1;
        flex-shrink: 0;
    }

    .step-indicator .step-title {
        display: inline-block;
        vertical-align: middle;
        font-size: 13px;
    }

    .step-navigation {
        flex-direction: column;
    }

    .step-navigation button {
        width: 100%;
    }
}

@media screen and (max-width: 480px) {
    body {
        padding: 5px;
    }

    .container {
        padding: 15px 10px;
    }

    h1 {
        font-size: 18px;
    }

    h2 {
        font-size: 14px;
        padding: 10px 8px;
    }

    h3 {
        font-size: 12px;
    }

    .info-box {
        padding: 10px;
        font-size: 12px;
    }

    .step-indicator .step-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        line-height: 1;
    }

    .step-indicator .step-title {
        font-size: 11px;
    }
}

@media screen and (max-width: 768px) and (orientation: landscape) {
    .signature-pad-container canvas {
        height: 100px;
    }
}

@media print {
    body {
        background: white;
        padding: 0;
    }

    .container {
        box-shadow: none;
        padding: 20px;
    }

    .button-container,
    .step-navigation,
    .progress-container {
        display: none;
    }

    .step-container {
        display: block !important;
    }
}

.page-break-before {
    page-break-before: always;
    break-before: page;
}

.page-break-after {
    page-break-after: always;
    break-after: page;
}

.no-break-inside {
    page-break-inside: avoid;
    break-inside: avoid;
}
</style>
</head>

<body>

<div class="container">
    <h1>RESIDENTIAL RENTAL APPLICATION</h1>
    <p class="subtitle">Please complete all sections accurately and legibly</p>

    <!-- Progress Indicator -->
    <div class="progress-container">
        <div class="progress-text">
            <span id="progressText">Step 1 of 7</span> - <span id="progressPercent">14%</span> Complete
        </div>
        <div class="progress-bar-wrapper">
            <div class="progress-bar" id="progressBar" style="width: 14%;"></div>
        </div>
        <div class="step-indicators" id="stepIndicators">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <form id="appForm">
        <div class="info-box"><strong>Required Documentation:</strong> You must present two (2) pieces of
            government-issued identification for verification. Incomplete applications will not be processed.</div>

        <!-- Step 1: Property & Personal Information -->
        <div class="step-container active" data-step="1">
            <h2>PROPERTY INFORMATION</h2>
            <div class="form-row">
                <div>
                    <label>Property Address Applying For:</label>
                    <input type="text" id="property_address"/>
                    <span class="error-message" id="error_property_address">Property address is required</span>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Desired Move-In Date:</label>
                    <input type="month" id="move_in_date" />
                </div>
                <div>
                    <label>Lease Term Requested: (1,2,3 Years)</label>
                    <input type="text" id="lease_term" />
                </div>
            </div>

            <h2>PERSONAL INFORMATION - PRIMARY APPLICANT</h2>
            <div class="form-row">
                <div>
                    <label>Full Legal Name: <span style="color: red;">*</span></label>
                    <input type="text" id="full_name" required/>
                    <span class="error-message" id="error_full_name">Full legal name is required</span>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Date of Birth:</label>
                    <input type="date" id="birthdate" />
                </div>
                <div>
                    <label>Marital Status:</label>
                    <input type="text" id="marital_status" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Primary Phone:</label>
                    <input type="tel" id="phone" />
                </div>
                <div>
                    <label>Alternate Phone:</label>
                    <input type="tel" id="cell" />
                </div>
            </div>

            <div class="form-group">
                <label>Email Address:</label>
                <input type="email" id="email" />
            </div>

            <div class="form-row">
                <div>
                    <label>Driver's License / ID Number:</label>
                    <input type="text" id="license" />
                </div>
                <div>
                    <label>Province/State of Issue:</label>
                    <input type="text" id="license_province" />
                </div>
            </div>
        </div>

        <!-- Step 2: Residence History -->
        <div class="step-container" data-step="2">
            <h2>CURRENT RESIDENCE</h2>
            <div class="form-group">
                <label>Current Address:</label>
                <input type="text" id="current_address" />
            </div>

            <div class="form-row">
                <div>
                    <label>City:</label>
                    <input type="text" id="current_city" />
                </div>
                <div>
                    <label>Province:</label>
                    <input type="text" id="current_province" />
                </div>
                <div>
                    <label>Postal Code:</label>
                    <input type="text" id="current_postal" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Landlord/Property Manager Name:</label>
                    <input type="text" id="current_landlord" />
                </div>
                <div>
                    <label>Landlord Phone:</label>
                    <input type="tel" id="current_landlord_phone" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Monthly Rent:</label>
                    <input type="text" id="current_rent" />
                </div>
                <div>
                    <label>Move-In Date:</label>
                    <input type="date" id="current_start" />
                </div>
                <div>
                    <label>Move-Out Date:</label>
                    <input type="date" id="current_end" />
                </div>
            </div>

            <div class="form-group">
                <label>Reason for Leaving:</label>
                <input type="text" id="reason_leaving" />
            </div>

            <h3>Previous Address #1</h3>
            <div class="form-group">
                <label>Address:</label>
                <input type="text" id="prev_address_1" />
            </div>

            <div class="form-row">
                <div>
                    <label>City:</label>
                    <input type="text" id="prev_city_1" />
                </div>
                <div>
                    <label>Province:</label>
                    <input type="text" id="prev_province_1" />
                </div>
                <div>
                    <label>Postal Code:</label>
                    <input type="text" id="prev_postal_1" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Landlord Name:</label>
                    <input type="text" id="prev_landlord_1" />
                </div>
                <div>
                    <label>Landlord Phone:</label>
                    <input type="tel" id="prev_landlord_phone_1" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Monthly Rent:</label>
                    <input type="text" id="prev_rent_1" />
                </div>
                <div>
                    <label>From Date:</label>
                    <input type="date" id="prev_start_1" />
                </div>
                <div>
                    <label>To Date:</label>
                    <input type="date" id="prev_end_1" />
                </div>
            </div>

            <h3>Previous Address #2</h3>
            <div class="form-group">
                <label>Address:</label>
                <input type="text" id="prev_address_2" />
            </div>

            <div class="form-row">
                <div>
                    <label>City:</label>
                    <input type="text" id="prev_city_2" />
                </div>
                <div>
                    <label>Province:</label>
                    <input type="text" id="prev_province_2" />
                </div>
                <div>
                    <label>Postal Code:</label>
                    <input type="text" id="prev_postal_2" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Landlord Name:</label>
                    <input type="text" id="prev_landlord_2" />
                </div>
                <div>
                    <label>Landlord Phone:</label>
                    <input type="tel" id="prev_landlord_phone_2" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Monthly Rent:</label>
                    <input type="text" id="prev_rent_2" />
                </div>
                <div>
                    <label>From Date:</label>
                    <input type="date" id="prev_start_2" />
                </div>
                <div>
                    <label>To Date:</label>
                    <input type="date" id="prev_end_2" />
                </div>
            </div>
        </div>

        <!-- Step 3: Employment & Income -->
        <div class="step-container" data-step="3">
            <h2>EMPLOYMENT & INCOME</h2>
            <h3>Current Employment</h3>
            <div class="form-row">
                <div>
                    <label>Employer Name:</label>
                    <input type="text" id="employer" />
                </div>
                <div>
                    <label>Occupation/Position:</label>
                    <input type="text" id="occupation" />
                </div>
            </div>

            <div class="form-group">
                <label>Employer Address:</label>
                <input type="text" id="employer_address" />
            </div>

            <div class="form-row">
                <div>
                    <label>Supervisor Name:</label>
                    <input type="text" id="supervisor" />
                </div>
                <div>
                    <label>Employer Phone:</label>
                    <input type="tel" id="employer_phone" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Employment Start Date:</label>
                    <input type="month" id="employment_start" />
                </div>
                <div>
                    <label>Gross Monthly Income:</label>
                    <input type="text" id="monthly_income" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Employment Type:(Full-Time,Part-Time,Self-Employed)</label>
                    <input type="text" id="employment_type" />
                </div>
            </div>

            <h3>Previous Employment</h3>
            <div class="form-row">
                <div>
                    <label>Employer Name:</label>
                    <input type="text" id="prev_employer" />
                </div>
                <div>
                    <label>Occupation/Position:</label>
                    <input type="text" id="prev_occupation" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Employer Phone:</label>
                    <input type="tel" id="prev_employer_phone" />
                </div>
                <div>
                    <label>From Date:</label>
                    <input type="month" id="prev_employment_start" />
                </div>
                <div>
                    <label>To Date:</label>
                    <input type="month" id="prev_employment_end" />
                </div>
            </div>

            <h3>Additional Income Sources</h3>
            <div class="form-row">
                <div>
                    <label>Other Income (pension, investments, etc):</label>
                    <input type="text" id="other_income_source" />
                </div>
                <div>
                    <label>Monthly Amount:</label>
                    <input type="text" id="other_income_amount" />
                </div>
            </div>
        </div>

        <!-- Step 4: Household Information -->
        <div class="step-container" data-step="4">
            <h2>VEHICLE INFORMATION</h2>
            <div class="form-row">
                <div>
                    <label>Do you own a vehicle?</label>
                    <div class="checkbox-group">
                        <label><input type="radio" name="vehicle_owned" value="yes" /> Yes</label>
                        <label><input type="radio" name="vehicle_owned" value="no" /> No</label>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Vehicle Make/Model:</label>
                    <input type="text" id="vehicle_make" />
                </div>
                <div>
                    <label>Year:</label>
                    <input type="text" id="vehicle_year" />
                </div>
                <div>
                    <label>License Plate:</label>
                    <input type="text" id="vehicle_plate" />
                </div>
            </div>

            <h2>ADDITIONAL OCCUPANTS</h2>
            <h3>Spouse/Co-Applicant (if applicable)</h3>
            <div class="form-row">
                <div>
                    <label>Full Name:</label>
                    <input type="text" id="spouse_name" />
                </div>
                <div>
                    <label>Date of Birth:</label>
                    <input type="date" id="spouse_dob" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Phone:</label>
                    <input type="tel" id="spouse_phone" />
                </div>
                <div>
                    <label>Email:</label>
                    <input type="email" id="spouse_email" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Employer:</label>
                    <input type="text" id="spouse_employer" />
                </div>
                <div>
                    <label>Occupation:</label>
                    <input type="text" id="spouse_occupation" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Employer Phone:</label>
                    <input type="tel" id="spouse_employer_phone" />
                </div>
                <div>
                    <label>Gross Monthly Income:</label>
                    <input type="text" id="spouse_income" />
                </div>
            </div>

            <h3>Other Occupants</h3>
            <div class="form-row">
                <div>
                    <label>Number of Adults (18+):</label>
                    <input type="number" id="num_adults" min="0" />
                </div>
                <div>
                    <label>Number of Children (Under 18):</label>
                    <input type="number" id="num_children" min="0" />
                </div>
            </div>

            <div class="form-group">
                <label>List All Occupants (Name, Age, Relationship):</label>
                <div class="form-row">
                    <div>
                        <label>Name:</label>
                        <input type="text" id="occupant1_name" />
                    </div>
                    <div>
                        <label>Relationship:</label>
                        <input type="text" id="occupant1_relationship" />
                    </div>
                    <div>
                        <label>Age:</label>
                        <input type="text" id="occupant1_age" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Name:</label>
                        <input type="text" id="occupant2_name" />
                    </div>
                    <div>
                        <label>Relationship:</label>
                        <input type="text" id="occupant2_relationship" />
                    </div>
                    <div>
                        <label>Age:</label>
                        <input type="text" id="occupant2_age" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Name:</label>
                        <input type="text" id="occupant3_name" />
                    </div>
                    <div>
                        <label>Relationship:</label>
                        <input type="text" id="occupant3_relationship" />
                    </div>
                    <div>
                        <label>Age:</label>
                        <input type="text" id="occupant3_age" />
                    </div>
                </div>
            </div>

            <h2>PETS & SMOKING</h2>
            <div class="form-row">
                <div>
                    <label>Do you have pets?</label>
                    <div class="checkbox-group">
                        <label><input type="radio" name="pets" value="yes" /> Yes</label>
                        <label><input type="radio" name="pets" value="no" /> No</label>
                    </div>
                </div>
                <div>
                    <label>Do you or any occupants smoke?</label>
                    <div class="checkbox-group">
                        <label><input type="radio" name="smokers" value="yes" /> Yes</label>
                        <label><input type="radio" name="smokers" value="no" /> No</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>If yes to pets, provide details (type, breed, weight, age):</label>
                <textarea id="pet_details" rows="5"></textarea>
            </div>
        </div>

        <!-- Step 5: Contacts & References -->
        <div class="step-container" data-step="5">
            <h2>EMERGENCY CONTACT</h2>
            <div class="form-row">
                <div>
                    <label>Name:</label>
                    <input type="text" id="emergency_name" />
                </div>
                <div>
                    <label>Relationship:</label>
                    <input type="text" id="emergency_relationship" />
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Phone:</label>
                    <input type="tel" id="emergency_phone" />
                </div>
                <div>
                    <label>Alternate Phone:</label>
                    <input type="tel" id="emergency_alt_phone" />
                </div>
            </div>

            <h2>REFERENCES</h2>
            <p class="small-text">Please provide three (3) references (not family members)</p>

            <h3>Reference 1</h3>
            <div class="form-row">
                <div>
                    <label>Name:</label>
                    <input type="text" id="ref1_name" />
                </div>
                <div>
                    <label>Relationship:</label>
                    <input type="text" id="ref1_relationship" />
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Phone:</label>
                    <input type="tel" id="ref1_phone" />
                </div>
                <div>
                    <label>Email:</label>
                    <input type="email" id="ref1_email" />
                </div>
            </div>

            <h3>Reference 2</h3>
            <div class="form-row">
                <div>
                    <label>Name:</label>
                    <input type="text" id="ref2_name" />
                </div>
                <div>
                    <label>Relationship:</label>
                    <input type="text" id="ref2_relationship" />
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Phone:</label>
                    <input type="tel" id="ref2_phone" />
                </div>
                <div>
                    <label>Email:</label>
                    <input type="email" id="ref2_email" />
                </div>
            </div>

            <h3>Reference 3</h3>
            <div class="form-row">
                <div>
                    <label>Name:</label>
                    <input type="text" id="ref3_name" />
                </div>
                <div>
                    <label>Relationship:</label>
                    <input type="text" id="ref3_relationship" />
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Phone:</label>
                    <input type="tel" id="ref3_phone" />
                </div>
                <div>
                    <label>Email:</label>
                    <input type="email" id="ref3_email" />
                </div>
            </div>
        </div>

        <!-- Step 6: Additional Information -->
        <div class="step-container" data-step="6">
            <h2>ADDITIONAL QUESTIONS</h2>
            <div class="form-group">
                <label>Have you ever been evicted from a rental property?</label>
                <div class="checkbox-group">
                    <label><input type="radio" name="evicted" value="yes" /> Yes</label>
                    <label><input type="radio" name="evicted" value="no" /> No</label>
                </div>
                <div style="margin-top: 10px;">
                    <label>If yes, please explain:</label>
                    <textarea id="evicted_explanation"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>Have you ever broken a lease or rental agreement?</label>
                <div class="checkbox-group">
                    <label><input type="radio" name="broken_lease" value="yes" /> Yes</label>
                    <label><input type="radio" name="broken_lease" value="no" /> No</label>
                </div>
                <div style="margin-top: 10px;">
                    <label>If yes, please explain:</label>
                    <textarea id="broken_lease_explanation"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>Have you ever filed for bankruptcy?</label>
                <div class="checkbox-group">
                    <label><input type="radio" name="bankruptcy" value="yes" /> Yes</label>
                    <label><input type="radio" name="bankruptcy" value="no" /> No</label>
                </div>
                <div style="margin-top: 10px;">
                    <label>If yes, when and status:</label>
                    <input type="text" id="bankruptcy_details" />
                </div>
            </div>

            <div class="form-group">
                <label>Have you ever been convicted of a criminal offense?</label>
                <div class="checkbox-group">
                    <label><input type="radio" name="criminal" value="yes" /> Yes</label>
                    <label><input type="radio" name="criminal" value="no" /> No</label>
                </div>
                <div style="margin-top: 10px;">
                    <label>If yes, please explain:</label>
                    <textarea id="criminal_explanation"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>Do you have renters insurance or plan to obtain it?</label>
                <div class="checkbox-group">
                    <label><input type="radio" name="insurance" value="yes" /> Yes</label>
                    <label><input type="radio" name="insurance" value="no" /> No</label>
                    <label><input type="radio" name="insurance" value="will_obtain" /> Will Obtain</label>
                </div>
            </div>

            <h2>ADDITIONAL INFORMATION</h2>
            <div class="form-group">
                <label>Is there any additional information you would like to provide?</label>
                <textarea id="additional_info"></textarea>
            </div>
        </div>

        <!-- Step 7: Review & Signatures -->
        <div class="step-container" data-step="7">
            <h2>DECLARATIONS AND AUTHORIZATION</h2>

            <div class="consent-text">
                <p><strong>I/We declare and certify that:</strong></p>
                <ul>
                    <li>All information provided in this application is true, accurate, and complete to the best of
                        my/our knowledge.</li>
                    <li>I/We authorize the landlord/property manager to verify all information provided, including but
                        not limited to employment, income, rental history, and personal references.</li>
                    <li>I/We authorize the landlord to obtain a consumer credit report and conduct criminal background
                        checks, eviction history searches, and other inquiries deemed necessary to assess my/our
                        eligibility and creditworthiness as a tenant.</li>
                    <li>I/We understand that providing false, misleading, or incomplete information may result in the
                        rejection of this application or termination of tenancy if discovered after occupancy has
                        commenced, in accordance with the Residential Tenancy Act of British Columbia.</li>
                    <li>I/We consent to the collection, use, and disclosure of personal information provided in this
                        application for the purposes of: assessing this rental application, managing the tenancy (if
                        approved), responding to emergencies, complying with legal obligations including the Residential
                        Tenancy Act, and collecting unpaid rent or damages. All personal information will be handled in
                        accordance with British Columbia's Personal Information Protection Act (PIPA).</li>
                    <li>I/We understand that this application constitutes an offer to rent and does not create a binding
                        tenancy agreement. The landlord reserves the right to accept or reject this application based on
                        the information provided, verification results, and comparison with other applicants.</li>
                    <li>I/We understand that any application fee paid is non-refundable and is used to cover the costs
                        of processing this application.</li>
                </ul>
            </div>

            <h3>Primary Applicant Signature</h3>
            <div class="signature-row">
                <div class="signature-field">
                    <label>Primary Applicant Full Name: <span style="color: red;">*</span></label>
                    <input type="text" id="primary_signature_name" required/>
                    <span class="error-message" id="error_primary_signature_name">Full name is required</span>
                </div>
            </div>

            <div class="signature-pad-container">
                <label>Draw Signature (or type below): <span style="color: red;">*</span></label>
                <canvas id="primarySignaturePad" width="400" height="150"></canvas>
                <div class="signature-controls">
                    <button type="button" onclick="clearPrimarySignature()">Clear Signature</button>
                </div>
                <label style="margin-top:15px;">OR Type Signature:</label>
                <input type="text" id="primary_typed_signature" class="typed-signature" placeholder="Type full legal name">
                <span class="error-message" id="error_primary_signature">Signature is required</span>
            </div>

            <div class="signature-row">
                <div class="signature-field">
                    <label>Date:</label>
                    <input type="date" id="primary_signature_date" />
                </div>
            </div>

            <h3 style="margin-top: 40px;">Co-Applicant Signature (if applicable)</h3>
            <div class="signature-row">
                <div class="signature-field">
                    <label>Co-Applicant Full Name:</label>
                    <input type="text" id="co_signature_name" />
                </div>
            </div>

            <div class="signature-pad-container">
                <label>Draw Signature (or type below):</label>
                <canvas id="coSignaturePad" width="400" height="150"></canvas>
                <div class="signature-controls">
                    <button type="button" onclick="clearCoSignature()">Clear Signature</button>
                </div>
                <label style="margin-top:15px;">OR Type Signature:</label>
                <input type="text" id="co_typed_signature" class="typed-signature" placeholder="Type full legal name">
            </div>

            <div class="signature-row">
                <div class="signature-field">
                    <label>Date:</label>
                    <input type="date" id="co_signature_date" />
                </div>
            </div>
        </div>

        <!-- Step Navigation -->
        <div class="step-navigation">
            <button type="button" class="btn-previous" id="btnPrevious" onclick="previousStep()" style="display: none;">Previous</button>
            <button type="button" class="btn-save" id="btnSave" onclick="saveProgress()">Save Progress</button>
            <button type="button" class="btn-next" id="btnNext" onclick="nextStep()">Next</button>
            <button type="submit" class="btn-download" id="btnSubmit" style="display: none;">Generate & Download PDF</button>
        </div>
    </form>
</div>

<!-- Sample Data for Testing - Comment out to disable -->
<script src="sample-data.js"></script>

<script>
const { jsPDF } = window.jspdf;

// Multi-Step Form State
let currentStep = 1;
const totalSteps = 7;
const stepTitles = [
    "Property & Personal",
    "Residence History",
    "Employment & Income",
    "Household Info",
    "Contacts & References",
    "Additional Info",
    "Review & Sign"
];

// Initialize signature pads with mobile support
function initializeSignaturePad(canvas) {
    if (!canvas) return null;
    
    const dpr = window.devicePixelRatio || 1;
    
    // Get dimensions - try multiple methods to handle hidden elements
    let width, height;
    const rect = canvas.getBoundingClientRect();
    
    if (rect.width > 0 && rect.height > 0) {
        // Element is visible, use getBoundingClientRect
        width = rect.width;
        height = rect.height;
    } else {
        // Element is hidden, use offsetWidth/offsetHeight or computed style
        width = canvas.offsetWidth || parseInt(getComputedStyle(canvas).width) || 400;
        height = canvas.offsetHeight || parseInt(getComputedStyle(canvas).height) || 150;
        
        // If still 0, use canvas attributes or defaults
        if (width === 0) width = parseInt(canvas.getAttribute('width')) || 400;
        if (height === 0) height = parseInt(canvas.getAttribute('height')) || 150;
    }
    
    // Set actual size in memory (scaled for retina displays)
    canvas.width = width * dpr;
    canvas.height = height * dpr;
    
    // Scale the drawing context so everything draws at the correct size
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    
    // Set display size (CSS pixels) - preserve existing CSS if any
    if (!canvas.style.width) {
        canvas.style.width = width + 'px';
    }
    if (!canvas.style.height) {
        canvas.style.height = height + 'px';
    }
    
    const signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3,
        throttle: 16,
    });
    
    // Prevent scrolling when drawing on mobile
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
    }, { passive: false });
    
    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
    }, { passive: false });
    
    return signaturePad;
}

// Initialize signature pads when DOM is ready
let primarySigPad, coSigPad;
document.addEventListener('DOMContentLoaded', function() {
    // Don't initialize signature pads here if step 7 is hidden
    // They will be initialized when step 7 becomes visible
    
    // Initialize step indicators
    initializeStepIndicators();
    
    // Load saved progress (with delay)
    setTimeout(() => {
        loadProgress();
    }, 100);
    
    // Auto-save on input
    setupAutoSave();
});

// Initialize step indicators
function initializeStepIndicators() {
    const container = document.getElementById('stepIndicators');
    container.innerHTML = '';
    
    stepTitles.forEach((title, index) => {
        const stepNum = index + 1;
        const indicator = document.createElement('div');
        indicator.className = 'step-indicator';
        indicator.setAttribute('data-step', stepNum);
        indicator.innerHTML = `
            <span class="step-number">${stepNum}</span>
            <span class="step-title">${title}</span>
        `;
        indicator.addEventListener('click', () => {
            if (stepNum <= getHighestCompletedStep()) {
                goToStep(stepNum);
            }
        });
        container.appendChild(indicator);
    });
    
    updateProgressIndicator();
}

// Get highest completed step
function getHighestCompletedStep() {
    let highest = 1;
    for (let i = 1; i <= totalSteps; i++) {
        if (isStepValid(i)) {
            highest = i;
        }
    }
    return highest;
}

// Update progress indicator
function updateProgressIndicator() {
    const percent = Math.round((currentStep / totalSteps) * 100);
    document.getElementById('progressText').textContent = `Step ${currentStep} of ${totalSteps}`;
    document.getElementById('progressPercent').textContent = `${percent}%`;
    document.getElementById('progressBar').style.width = `${percent}%`;
    
    // Update step indicators
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        const stepNum = index + 1;
        indicator.classList.remove('active', 'completed');
        
        if (stepNum < currentStep) {
            indicator.classList.add('completed');
        } else if (stepNum === currentStep) {
            indicator.classList.add('active');
        }
    });
    
    // Update navigation buttons
    document.getElementById('btnPrevious').style.display = currentStep === 1 ? 'none' : 'block';
    document.getElementById('btnNext').style.display = currentStep === totalSteps ? 'none' : 'block';
    document.getElementById('btnSubmit').style.display = currentStep === totalSteps ? 'block' : 'none';
}

// Go to specific step
function goToStep(step) {
    if (step < 1 || step > totalSteps) return;
    
    // Hide current step
    document.querySelector('.step-container.active').classList.remove('active');
    
    // Show new step
    currentStep = step;
    document.querySelector(`.step-container[data-step="${step}"]`).classList.add('active');
    
    // Initialize/reinitialize signature pads when step 7 becomes visible
    if (step === 7) {
        // Use requestAnimationFrame to ensure step is fully visible
        requestAnimationFrame(() => {
            // Wait a bit more to ensure DOM has updated
            setTimeout(() => {
                const primaryCanvas = document.getElementById("primarySignaturePad");
                const coCanvas = document.getElementById("coSignaturePad");
                
                // Save existing signature data before reinitializing
                let savedPrimarySig = null;
                let savedCoSig = null;
                if (primarySigPad && !primarySigPad.isEmpty()) {
                    savedPrimarySig = primarySigPad.toDataURL();
                }
                if (coSigPad && !coSigPad.isEmpty()) {
                    savedCoSig = coSigPad.toDataURL();
                }
                
                // Always reinitialize to ensure correct dimensions when step becomes visible
                if (primaryCanvas) {
                    primarySigPad = initializeSignaturePad(primaryCanvas);
                    // Restore signature if it existed
                    if (savedPrimarySig) {
                        try {
                            primarySigPad.fromDataURL(savedPrimarySig);
                        } catch (e) {
                            console.error('Error restoring primary signature:', e);
                        }
                    }
                }
                if (coCanvas) {
                    coSigPad = initializeSignaturePad(coCanvas);
                    // Restore signature if it existed
                    if (savedCoSig) {
                        try {
                            coSigPad.fromDataURL(savedCoSig);
                        } catch (e) {
                            console.error('Error restoring co-applicant signature:', e);
                        }
                    }
                }
                
                // Also try to restore from localStorage if no existing signatures
                if (!savedPrimarySig && !savedCoSig) {
                    const saved = localStorage.getItem('rentalApplicationProgress');
                    if (saved) {
                        try {
                            const formData = JSON.parse(saved);
                            if (formData.primarySignatureData && primarySigPad) {
                                setTimeout(() => {
                                    try {
                                        primarySigPad.fromDataURL(formData.primarySignatureData);
                                    } catch (e) {
                                        console.error('Error restoring primary signature from storage:', e);
                                    }
                                }, 50);
                            }
                            if (formData.coSignatureData && coSigPad) {
                                setTimeout(() => {
                                    try {
                                        coSigPad.fromDataURL(formData.coSignatureData);
                                    } catch (e) {
                                        console.error('Error restoring co-applicant signature from storage:', e);
                                    }
                                }, 50);
                            }
                        } catch (e) {
                            console.error('Error parsing saved data:', e);
                        }
                    }
                }
            }, 200);
        });
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    updateProgressIndicator();
    saveProgress();
}

// Next step
function nextStep() {
    if (validateStep(currentStep)) {
        if (currentStep < totalSteps) {
            goToStep(currentStep + 1);
        }
    }
}

// Previous step
function previousStep() {
    if (currentStep > 1) {
        goToStep(currentStep - 1);
    }
}

// Validate step
function validateStep(step) {
    clearStepErrors(step);
    let isValid = true;
    
    switch(step) {
        case 1:
            if (!getValue('full_name')) {
                showError('full_name', 'Full legal name is required');
                isValid = false;
            }
            if (!getValue('property_address')) {
                showError('property_address', 'Property address is required');
                isValid = false;
            }
            break;
        case 7:
            if (!getValue('primary_signature_name')) {
                showError('primary_signature_name', 'Primary applicant full name is required');
                isValid = false;
            }
            const hasSignature = (primarySigPad && !primarySigPad.isEmpty()) || getValue('primary_typed_signature');
            if (!hasSignature) {
                showError('primary_signature', 'Primary applicant signature is required');
                isValid = false;
            }
            break;
    }
    
    if (!isValid) {
        // Scroll to first error
        const firstError = document.querySelector('.field-error');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
    }
    
    return isValid;
}

// Show error
function showError(fieldId, message) {
    const field = document.getElementById(fieldId);
    if (field) {
        field.classList.add('field-error');
        const errorEl = document.getElementById(`error_${fieldId}`);
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
    }
}

// Clear step errors
function clearStepErrors(step) {
    const stepContainer = document.querySelector(`.step-container[data-step="${step}"]`);
    if (stepContainer) {
        stepContainer.querySelectorAll('.field-error').forEach(el => {
            el.classList.remove('field-error');
        });
        stepContainer.querySelectorAll('.error-message').forEach(el => {
            el.classList.remove('show');
        });
    }
}

// Save progress to localStorage
function saveProgress() {
    const formData = {};
    
    // Save all form inputs
    document.querySelectorAll('#appForm input, #appForm textarea, #appForm select').forEach(input => {
        if (input.type === 'radio') {
            if (input.checked) {
                formData[input.name] = input.value;
            }
        } else {
            formData[input.id] = input.value;
        }
    });
    
    // Save signature pad data
    if (primarySigPad && !primarySigPad.isEmpty()) {
        formData.primarySignatureData = primarySigPad.toDataURL();
    }
    if (coSigPad && !coSigPad.isEmpty()) {
        formData.coSignatureData = coSigPad.toDataURL();
    }
    
    // Save current step
    formData.currentStep = currentStep;
    
    localStorage.setItem('rentalApplicationProgress', JSON.stringify(formData));
}

// Load progress from localStorage
function loadProgress() {
    const saved = localStorage.getItem('rentalApplicationProgress');
    if (!saved) return;
    
    try {
        const formData = JSON.parse(saved);
        
        // Restore form inputs
        Object.keys(formData).forEach(key => {
            if (key === 'currentStep' || key === 'primarySignatureData' || key === 'coSignatureData') return;
            
            const element = document.getElementById(key);
            if (element) {
                if (element.type === 'radio') {
                    const radio = document.querySelector(`input[name="${key}"][value="${formData[key]}"]`);
                    if (radio) radio.checked = true;
                } else {
                    element.value = formData[key] || '';
                }
            }
        });
        
        // Restore signatures (with retry if pads not ready)
        if (formData.primarySignatureData) {
            if (primarySigPad) {
                try {
                    primarySigPad.fromDataURL(formData.primarySignatureData);
                } catch (e) {
                    console.error('Error restoring primary signature:', e);
                }
            } else {
                // Retry after a short delay
                setTimeout(() => {
                    if (primarySigPad && formData.primarySignatureData) {
                        try {
                            primarySigPad.fromDataURL(formData.primarySignatureData);
                        } catch (e) {
                            console.error('Error restoring primary signature:', e);
                        }
                    }
                }, 200);
            }
        }
        if (formData.coSignatureData) {
            if (coSigPad) {
                try {
                    coSigPad.fromDataURL(formData.coSignatureData);
                } catch (e) {
                    console.error('Error restoring co-applicant signature:', e);
                }
            } else {
                // Retry after a short delay
                setTimeout(() => {
                    if (coSigPad && formData.coSignatureData) {
                        try {
                            coSigPad.fromDataURL(formData.coSignatureData);
                        } catch (e) {
                            console.error('Error restoring co-applicant signature:', e);
                        }
                    }
                }, 200);
            }
        }
        
        // Restore step (optional - user might want to start from beginning)
        // if (formData.currentStep) {
        //     goToStep(formData.currentStep);
        // }
        
    } catch (e) {
        console.error('Error loading progress:', e);
    }
}

// Setup auto-save on input
function setupAutoSave() {
    document.querySelectorAll('#appForm input, #appForm textarea, #appForm select').forEach(input => {
        input.addEventListener('input', debounce(saveProgress, 1000));
        input.addEventListener('change', saveProgress);
    });
}

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Check if step is valid (has some data)
function isStepValid(step) {
    const stepContainer = document.querySelector(`.step-container[data-step="${step}"]`);
    if (!stepContainer) return false;
    
    const inputs = stepContainer.querySelectorAll('input, textarea, select');
    for (let input of inputs) {
        if (input.type === 'radio' || input.type === 'checkbox') {
            if (input.checked) return true;
        } else if (input.value && input.value.trim()) {
            return true;
        }
    }
    return false;
}

// Auto-populate signature dates with today's date
function setTodayDate() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    
    const primaryDateField = document.getElementById("primary_signature_date");
    const coDateField = document.getElementById("co_signature_date");
    
    if (primaryDateField && !primaryDateField.value) {
        primaryDateField.value = todayStr;
    }
    if (coDateField && !coDateField.value) {
        coDateField.value = todayStr;
    }
}

// Set today's date when page loads
setTodayDate();

// Helper functions for signature pad buttons
function clearPrimarySignature() {
    if (primarySigPad) {
        primarySigPad.clear();
        saveProgress();
    }
}

function clearCoSignature() {
    if (coSigPad) {
        coSigPad.clear();
        saveProgress();
    }
}

// Helper function to get element value safely
function getValue(id) {
    const el = document.getElementById(id);
    return el ? el.value.trim() : '';
}

// Helper function to get radio button value
function getRadioValue(name) {
    const radios = document.querySelectorAll(`input[name="${name}"]:checked`);
    return radios.length > 0 ? radios[0].value : '';
}

// Helper function to format date
function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        if (dateStr.match(/^\d{4}-\d{2}$/)) {
            const [year, month] = dateStr.split('-');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-CA');
    } catch {
        return dateStr;
    }
}

// Clear form function
function clearForm() {
    if (confirm('Are you sure you want to clear all form data?')) {
        document.getElementById('appForm').reset();
        if (primarySigPad) primarySigPad.clear();
        if (coSigPad) coSigPad.clear();
        localStorage.removeItem('rentalApplicationProgress');
        setTodayDate();
        goToStep(1);
    }
}

// Validate form
function validateForm() {
    // Validate all steps
    for (let i = 1; i <= totalSteps; i++) {
        if (!validateStep(i)) {
            goToStep(i);
            return false;
        }
    }
    return true;
}

// Generate PDF (same as original, but with validation)
document.getElementById("appForm").addEventListener("submit", function(e) {
    e.preventDefault();
    if (!validateForm()) return;

    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let yPos = 15;
    const margin = 12;
    const topMargin = 15;
    const bottomMargin = 25;
    let pageNum = 1;

    function addPageNumber() {
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text(
                `Page ${i} of ${totalPages}`,
                pageWidth / 2,
                pageHeight - 10,
                { align: 'center' }
            );
            doc.setTextColor(0, 0, 0);
        }
    }

    function checkPageBreak(requiredSpace = 20) {
        if (yPos + requiredSpace > pageHeight - bottomMargin) {
            doc.addPage();
            pageNum++;
            yPos = topMargin;
            return true;
        }
        return false;
    }

    function addSectionHeader(title) {
        checkPageBreak(12);
        yPos += 3;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(240, 240, 240);
        doc.rect(margin, yPos - 3, pageWidth - 2 * margin, 7, 'F');
        doc.setDrawColor(100, 100, 100);
        doc.setLineWidth(0.5);
        doc.line(margin, yPos - 3, pageWidth - margin, yPos - 3);
        doc.line(margin, yPos + 4, pageWidth - margin, yPos + 4);
        doc.setTextColor(44, 62, 80);
        doc.text(title, margin + 3, yPos + 2);
        yPos += 10;
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
    }

    function addTable(data, startY, options = {}) {
        const filteredData = data
            .map(row => [row[0], row[1] || ''])
            .filter(row => row[1] || options.showEmpty);
        if (filteredData.length === 0 && !options.showEmpty) return startY;
        
        doc.autoTable({
            startY: startY,
            body: filteredData,
            styles: { 
                fontSize: 8.5,
                cellPadding: { top: 2.5, bottom: 2.5, left: 3, right: 3 },
                overflow: 'linebreak',
                cellWidth: 'wrap',
                lineColor: [200, 200, 200],
                lineWidth: 0.3,
                textColor: [0, 0, 0],
                minCellHeight: 6
            },
            headStyles: {
                fillColor: [245, 245, 245],
                textColor: [44, 62, 80],
                fontStyle: 'bold',
                fontSize: 8.5
            },
            alternateRowStyles: {
                fillColor: [252, 252, 252]
            },
            columnStyles: { 
                0: { 
                    fontStyle: 'bold', 
                    cellWidth: options.labelWidth || 75,
                    textColor: [60, 60, 60]
                },
                1: { 
                    cellWidth: 'auto',
                    textColor: [30, 30, 30]
                }
            },
            margin: { left: margin, right: margin, top: 2 },
            theme: 'striped',
            showHead: false
        });
        return doc.lastAutoTable.finalY + 3;
    }

    function addSubsectionHeader(title) {
        checkPageBreak(10);
        yPos += 2;
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(60, 60, 60);
        doc.text(title, margin, yPos);
        yPos += 6;
        doc.setFontSize(8.5);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
    }

    // Page 1: Professional Header and Property Information
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text("RESIDENTIAL RENTAL APPLICATION", pageWidth / 2, yPos, { align: "center" });
    yPos += 7;
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(100, 100, 100);
    doc.text("Please complete all sections accurately and legibly", pageWidth / 2, yPos, { align: "center" });
    yPos += 12;

    addSectionHeader("PROPERTY INFORMATION");
    const propertyData = [
        ["Property Address", getValue('property_address')],
        ["Desired Move-In Date", formatDate(getValue('move_in_date'))],
        ["Lease Term Requested", getValue('lease_term') ? getValue('lease_term') + ' year(s)' : '']
    ];
    yPos = addTable(propertyData, yPos);

    checkPageBreak(25);
    addSectionHeader("PERSONAL INFORMATION - PRIMARY APPLICANT");
    const primaryData = [
        ["Full Legal Name", getValue('full_name')],
        ["Date of Birth", formatDate(getValue('birthdate'))],
        ["Marital Status", getValue('marital_status')],
        ["Primary Phone", getValue('phone')],
        ["Alternate Phone", getValue('cell')],
        ["Email Address", getValue('email')],
        ["Driver's License / ID Number", getValue('license')],
        ["Province/State of Issue", getValue('license_province')]
    ];
    yPos = addTable(primaryData, yPos);

    checkPageBreak(35);
    addSectionHeader("RESIDENCE HISTORY");
    
    addSubsectionHeader("Current Residence");
    const currentResidenceData = [
        ["Address", getValue('current_address')],
        ["City, Province, Postal", [getValue('current_city'), getValue('current_province'), getValue('current_postal')].filter(x => x).join(', ')],
        ["Landlord/Property Manager", getValue('current_landlord')],
        ["Landlord Phone", getValue('current_landlord_phone')],
        ["Monthly Rent", getValue('current_rent') ? '$' + getValue('current_rent') : ''],
        ["Move-In Date", formatDate(getValue('current_start'))],
        ["Move-Out Date", formatDate(getValue('current_end'))],
        ["Reason for Leaving", getValue('reason_leaving')]
    ];
    yPos = addTable(currentResidenceData, yPos);

    checkPageBreak(25);
    addSubsectionHeader("Previous Address #1");
    const prev1Data = [
        ["Address", getValue('prev_address_1')],
        ["City, Province, Postal", [getValue('prev_city_1'), getValue('prev_province_1'), getValue('prev_postal_1')].filter(x => x).join(', ')],
        ["Landlord Name", getValue('prev_landlord_1')],
        ["Landlord Phone", getValue('prev_landlord_phone_1')],
        ["Monthly Rent", getValue('prev_rent_1') ? '$' + getValue('prev_rent_1') : ''],
        ["From Date", formatDate(getValue('prev_start_1'))],
        ["To Date", formatDate(getValue('prev_end_1'))]
    ];
    yPos = addTable(prev1Data, yPos);

    checkPageBreak(25);
    addSubsectionHeader("Previous Address #2");
    const prev2Data = [
        ["Address", getValue('prev_address_2')],
        ["City, Province, Postal", [getValue('prev_city_2'), getValue('prev_province_2'), getValue('prev_postal_2')].filter(x => x).join(', ')],
        ["Landlord Name", getValue('prev_landlord_2')],
        ["Landlord Phone", getValue('prev_landlord_phone_2')],
        ["Monthly Rent", getValue('prev_rent_2') ? '$' + getValue('prev_rent_2') : ''],
        ["From Date", formatDate(getValue('prev_start_2'))],
        ["To Date", formatDate(getValue('prev_end_2'))]
    ];
    yPos = addTable(prev2Data, yPos);

    checkPageBreak(35);
    addSectionHeader("EMPLOYMENT & INCOME");
    
    addSubsectionHeader("Current Employment");
    const currentEmploymentData = [
        ["Employer Name", getValue('employer')],
        ["Occupation/Position", getValue('occupation')],
        ["Employer Address", getValue('employer_address')],
        ["Supervisor Name", getValue('supervisor')],
        ["Employer Phone", getValue('employer_phone')],
        ["Employment Start Date", formatDate(getValue('employment_start'))],
        ["Gross Monthly Income", getValue('monthly_income') ? '$' + getValue('monthly_income') : ''],
        ["Employment Type", getValue('employment_type')]
    ];
    yPos = addTable(currentEmploymentData, yPos);

    checkPageBreak(20);
    addSubsectionHeader("Previous Employment");
    const prevEmploymentData = [
        ["Employer Name", getValue('prev_employer')],
        ["Occupation/Position", getValue('prev_occupation')],
        ["Employer Phone", getValue('prev_employer_phone')],
        ["From Date", formatDate(getValue('prev_employment_start'))],
        ["To Date", formatDate(getValue('prev_employment_end'))]
    ];
    yPos = addTable(prevEmploymentData, yPos);

    checkPageBreak(15);
    addSubsectionHeader("Additional Income Sources");
    const otherIncomeData = [
        ["Other Income Source", getValue('other_income_source')],
        ["Monthly Amount", getValue('other_income_amount') ? '$' + getValue('other_income_amount') : '']
    ];
    yPos = addTable(otherIncomeData, yPos);

    checkPageBreak(30);
    addSectionHeader("VEHICLE INFORMATION");
    const vehicleOwned = getRadioValue('vehicle_owned');
    const vehicleData = [
        ["Do you own a vehicle?", vehicleOwned ? vehicleOwned.charAt(0).toUpperCase() + vehicleOwned.slice(1) : ''],
        ["Vehicle Make/Model", getValue('vehicle_make')],
        ["Year", getValue('vehicle_year')],
        ["License Plate", getValue('vehicle_plate')]
    ];
    yPos = addTable(vehicleData, yPos);

    checkPageBreak(30);
    addSectionHeader("ADDITIONAL OCCUPANTS");
    addSubsectionHeader("Spouse/Co-Applicant");
    const spouseData = [
        ["Full Name", getValue('spouse_name')],
        ["Date of Birth", formatDate(getValue('spouse_dob'))],
        ["Phone", getValue('spouse_phone')],
        ["Email", getValue('spouse_email')],
        ["Employer", getValue('spouse_employer')],
        ["Occupation", getValue('spouse_occupation')],
        ["Employer Phone", getValue('spouse_employer_phone')],
        ["Gross Monthly Income", getValue('spouse_income') ? '$' + getValue('spouse_income') : '']
    ];
    yPos = addTable(spouseData, yPos);

    checkPageBreak(20);
    addSubsectionHeader("Other Occupants");
    const occupantsData = [
        ["Number of Adults (18+)", getValue('num_adults')],
        ["Number of Children (Under 18)", getValue('num_children')]
    ];
    yPos = addTable(occupantsData, yPos);

    const occupants = [];
    for (let i = 1; i <= 3; i++) {
        const name = getValue(`occupant${i}_name`);
        if (name) {
            occupants.push([
                `Occupant ${i}`,
                `${name} (${getValue(`occupant${i}_relationship`)}, Age: ${getValue(`occupant${i}_age`)})`
            ]);
        }
    }
    if (occupants.length > 0) {
        checkPageBreak(occupants.length * 6);
        yPos = addTable(occupants, yPos);
    }

    checkPageBreak(20);
    addSectionHeader("PETS & SMOKING");
    const petsSmokingData = [
        ["Do you have pets?", getRadioValue('pets') ? getRadioValue('pets').charAt(0).toUpperCase() + getRadioValue('pets').slice(1) : ''],
        ["Pet Details", getValue('pet_details')],
        ["Do you or any occupants smoke?", getRadioValue('smokers') ? getRadioValue('smokers').charAt(0).toUpperCase() + getRadioValue('smokers').slice(1) : '']
    ];
    yPos = addTable(petsSmokingData, yPos);

    checkPageBreak(25);
    addSectionHeader("EMERGENCY CONTACT");
    const emergencyData = [
        ["Name", getValue('emergency_name')],
        ["Relationship", getValue('emergency_relationship')],
        ["Phone", getValue('emergency_phone')],
        ["Alternate Phone", getValue('emergency_alt_phone')]
    ];
    yPos = addTable(emergencyData, yPos);

    checkPageBreak(30);
    addSectionHeader("REFERENCES");
    for (let i = 1; i <= 3; i++) {
        checkPageBreak(20);
        addSubsectionHeader(`Reference ${i}`);
        const refData = [
            ["Name", getValue(`ref${i}_name`)],
            ["Relationship", getValue(`ref${i}_relationship`)],
            ["Phone", getValue(`ref${i}_phone`)],
            ["Email", getValue(`ref${i}_email`)]
        ];
        yPos = addTable(refData, yPos);
    }

    checkPageBreak(30);
    addSectionHeader("ADDITIONAL QUESTIONS");
    const additionalQuestionsData = [
        ["Ever been evicted?", getRadioValue('evicted') ? getRadioValue('evicted').charAt(0).toUpperCase() + getRadioValue('evicted').slice(1) : ''],
        ["Eviction Explanation", getValue('evicted_explanation')],
        ["Ever broken a lease?", getRadioValue('broken_lease') ? getRadioValue('broken_lease').charAt(0).toUpperCase() + getRadioValue('broken_lease').slice(1) : ''],
        ["Broken Lease Explanation", getValue('broken_lease_explanation')],
        ["Ever filed for bankruptcy?", getRadioValue('bankruptcy') ? getRadioValue('bankruptcy').charAt(0).toUpperCase() + getRadioValue('bankruptcy').slice(1) : ''],
        ["Bankruptcy Details", getValue('bankruptcy_details')],
        ["Ever convicted of criminal offense?", getRadioValue('criminal') ? getRadioValue('criminal').charAt(0).toUpperCase() + getRadioValue('criminal').slice(1) : ''],
        ["Criminal Explanation", getValue('criminal_explanation')],
        ["Renters Insurance", getRadioValue('insurance') ? getRadioValue('insurance').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : '']
    ];
    yPos = addTable(additionalQuestionsData, yPos);

    checkPageBreak(20);
    addSectionHeader("ADDITIONAL INFORMATION");
    const additionalInfo = getValue('additional_info');
    if (additionalInfo) {
        doc.setFontSize(8.5);
        doc.setTextColor(30, 30, 30);
        const splitText = doc.splitTextToSize(additionalInfo, pageWidth - 2 * margin);
        doc.text(splitText, margin, yPos);
        yPos += splitText.length * 4.5;
        doc.setTextColor(0, 0, 0);
    } else {
        doc.setFontSize(8.5);
        doc.setTextColor(150, 150, 150);
        doc.text("No additional information provided.", margin, yPos);
        yPos += 6;
        doc.setTextColor(0, 0, 0);
    }

    checkPageBreak(40);
    addSectionHeader("DECLARATIONS AND AUTHORIZATION");
    
    doc.setFontSize(8);
    doc.setTextColor(40, 40, 40);
    const declarations = [
        "I/We declare and certify that:",
        " All information provided in this application is true, accurate, and complete.",
        " I/We authorize verification of all information provided.",
        " I/We authorize credit reports, criminal background checks, and eviction history searches.",
        " I/We understand that false information may result in rejection or termination.",
        " I/We consent to collection, use, and disclosure of personal information per PIPA.",
        " This application constitutes an offer to rent, not a binding tenancy agreement.",
        " Any application fee paid is non-refundable."
    ];
    
    declarations.forEach((declaration, index) => {
        checkPageBreak(5);
        if (index === 0) {
            doc.setFont(undefined, 'bold');
            doc.setFontSize(8.5);
        } else {
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
        }
        const splitText = doc.splitTextToSize(declaration, pageWidth - 2 * margin);
        doc.text(splitText, margin, yPos);
        yPos += splitText.length * 4.2;
    });
    doc.setTextColor(0, 0, 0);

    checkPageBreak(45);
    yPos += 5;
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.3);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text("Primary Applicant", margin, yPos);
    yPos += 6;
    doc.setFontSize(8.5);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`Full Name: ${getValue('primary_signature_name')}`, margin, yPos);
    yPos += 8;
    
    const primarySigName = getValue('primary_typed_signature');
    if (primarySigPad && !primarySigPad.isEmpty()) {
        try {
            const sigData = primarySigPad.toDataURL();
            doc.addImage(sigData, 'PNG', margin, yPos, 70, 25);
            yPos += 30;
        } catch (e) {
            doc.setFont(undefined, 'italic');
            doc.setFontSize(9);
            doc.text(primarySigName || 'Signature required', margin, yPos + 8);
            yPos += 12;
        }
    } else if (primarySigName) {
        doc.setFont(undefined, 'italic');
        doc.setFontSize(9);
        doc.text(primarySigName, margin, yPos + 8);
        yPos += 12;
    }
    
    doc.setFont(undefined, 'normal');
    doc.setFontSize(8.5);
    doc.text(`Date: ${formatDate(getValue('primary_signature_date')) || new Date().toLocaleDateString()}`, margin, yPos);

    const coName = getValue('co_signature_name');
    if (coName || (coSigPad && !coSigPad.isEmpty()) || getValue('co_typed_signature')) {
        checkPageBreak(45);
        yPos += 12;
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, yPos, pageWidth - margin, yPos);
        yPos += 8;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(44, 62, 80);
        doc.text("Co-Applicant", margin, yPos);
        yPos += 6;
        doc.setFontSize(8.5);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text(`Full Name: ${coName}`, margin, yPos);
        yPos += 8;
        
        const coSigName = getValue('co_typed_signature');
        if (coSigPad && !coSigPad.isEmpty()) {
            try {
                const sigData = coSigPad.toDataURL();
                doc.addImage(sigData, 'PNG', margin, yPos, 70, 25);
                yPos += 30;
            } catch (e) {
                doc.setFont(undefined, 'italic');
                doc.setFontSize(9);
                doc.text(coSigName || 'Signature required', margin, yPos + 8);
                yPos += 12;
            }
        } else if (coSigName) {
            doc.setFont(undefined, 'italic');
            doc.setFontSize(9);
            doc.text(coSigName, margin, yPos + 8);
            yPos += 12;
        }
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(8.5);
        doc.text(`Date: ${formatDate(getValue('co_signature_date')) || new Date().toLocaleDateString()}`, margin, yPos);
    }

    addPageNumber();

    // Clear localStorage on successful submission
    localStorage.removeItem('rentalApplicationProgress');
    
    // Save PDF
    doc.save("Residential-Rental-Application.pdf");
    
    // Show success message
    alert('PDF generated successfully! Your application has been saved.');
});
</script>

</body>
</html>

